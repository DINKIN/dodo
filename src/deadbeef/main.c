#include <stdio.h>
#include <stdlib.h>
#include "../common/api.h"
#include "../common/game.h"


#define NORMAL 0
#define ABDUCTING 1
#define FALLING 2
#define LEFT 3
#define RIGHT  4
#define FARTING 5
#define REGENERATING 6

#define _D1 210
#define _E1 188
#define _G1 158
#define _D2 104
#define _A 140
#define _B 125
#define _C 118
#define _FS2 83
#define _G2 78
#define _P 1


static unsigned char const _title[1024] = { 0x00, 0x00, 0xf0, 0xf0, 0x0c, 0x0c, 0xcc, 0xcc, 0x3c, 0x3c, 0xf0, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xfc, 0x0c, 0x0c, 0x0c, 0x0c, 0x30, 0x30, 0xc0, 0xc0, 0x00, 0x00, 0xfc, 0xfc, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x00, 0x00, 0xf0, 0xf0, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0xf0, 0xf0, 0x00, 0x00, 0xfc, 0xfc, 0x0c, 0x0c, 0x0c, 0x0c, 0x30, 0x30, 0xc0, 0xc0, 0x00, 0x00, 0xfc, 0xfc, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0xf0, 0xf0, 0x00, 0x00, 0xfc, 0xfc, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x00, 0x00, 0xfc, 0xfc, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x00, 0x00, 0xfc, 0xfc, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x3f, 0xc3, 0xc3, 0xc0, 0xc0, 0xc0, 0xc0, 0x3f, 0x3f, 0x00, 0x00, 0xcc, 0xcc, 0x30, 0x30, 0xcc, 0xcc, 0x00, 0x00, 0xff, 0xff, 0xc0, 0xc0, 0xc0, 0xc0, 0x30, 0x30, 0x0f, 0x0f, 0x00, 0x00, 0xff, 0xff, 0xc3, 0xc3, 0xc3, 0xc3, 0xc0, 0xc0, 0x00, 0x00, 0xff, 0xff, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0xff, 0xff, 0x00, 0x00, 0xff, 0xff, 0xc0, 0xc0, 0xc0, 0xc0, 0x30, 0x30, 0x0f, 0x0f, 0x00, 0x00, 0xff, 0xff, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0xc3, 0x3c, 0x3c, 0x00, 0x00, 0xff, 0xff, 0xc3, 0xc3, 0xc3, 0xc3, 0xc0, 0xc0, 0x00, 0x00, 0xff, 0xff, 0xc3, 0xc3, 0xc3, 0xc3, 0xc0, 0xc0, 0x00, 0x00, 0xff, 0xff, 0x03, 0x03, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x44, 0x10, 0x28, 0x00, 0x44, 0x38, 0x00, 0x00, 0x7c, 0x14, 0x08, 0x00, 0x7c, 0x54, 0x44, 0x00, 0x04, 0x7c, 0x04, 0x00, 0x7c, 0x54, 0x44, 0x00, 0x7c, 0x14, 0x68, 0x00, 0x00, 0x00, 0x7c, 0x08, 0x10, 0x7c, 0x00, 0x38, 0x44, 0x38, 0x00, 0x1c, 0x70, 0x1c, 0x00, 0x7c, 0x54, 0x44, 0x00, 0x5c, 0x54, 0x74, 0x00, 0x40, 0x00, 0x00, 0x64, 0x54, 0x48, 0x00, 0x38, 0x44, 0x38, 0x00, 0x08, 0x7c, 0x00, 0x38, 0x54, 0x54, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

static unsigned char const _deadbeef_tiles[16] = { 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0 };

static unsigned char const _music[48] = { _G1, 7, 0, 1, _G1, 7, 0, 1, _G1, 8, _D1, 8, _E1, 7, 0, 1, _E1, 8, _D1, 16, _B, 7, 0, 1, _B, 8, _A, 7, 0, 1, _A, 8, _G2, 4, _FS2, 4, _G2, 4, _FS2, 4, _G2, 4, _FS2, 4, _D1, 8, 0, 0 };
static unsigned char const _abduction_effect[10] = { 251, 1, 253, 1, 255, 1, 253, 1, 0, 0 };

static unsigned char const _saucer[16] = { 0x20, 0x70, 0x50, 0x78, 0x58, 0x78, 0xde, 0xf3, 0xf3, 0xde, 0x78, 0x58, 0x78, 0x50, 0x70, 0x20  };
static unsigned char const _cow[48] = { 0x00, 0x80, 0x70, 0xf8, 0x38, 0x18, 0xf8, 0xf8, 0x18, 0x18, 0x38, 0x70, 0xf0, 0x70, 0x20, 0xe6, 0xfe, 0xdc, 0xf4, 0x80, 0xf4, 0xdc, 0xfe, 0x06, 0x0c, 0x03, 0x00, 0xff, 0xfe, 0x0c, 0x1d, 0x0f, 0x1f, 0x07, 0x06, 0x06, 0x07, 0x06, 0xfc, 0xfc, 0x07, 0x07, 0x0d, 0x0f, 0x0d, 0x07, 0x07, 0x00 };
static unsigned char const _abduction1[48] = { 0x00, 0x00, 0xe0, 0xf0, 0x38, 0x1c, 0xfe, 0xfe, 0x1e, 0x1e, 0x3c, 0x78, 0xf8, 0x70, 0x20, 0xcc, 0xfc, 0xb8, 0xe8, 0x00, 0xe8, 0xb8, 0xfc, 0x0c, 0x00, 0x0c, 0x03, 0x7f, 0x7e, 0x0c, 0x1d, 0x0f, 0x1f, 0x07, 0x02, 0x02, 0x03, 0x06, 0x7c, 0x79, 0x07, 0x0f, 0x1b, 0x1f, 0x1b, 0x0f, 0x07, 0x00 };
static unsigned char const _abduction2[48] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xf0, 0x3c, 0x1e, 0xff, 0xff, 0x1e, 0x98, 0x70, 0x20, 0xcc, 0xfc, 0xb8, 0xe0, 0xb8, 0xfc, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x03, 0x3f, 0x3e, 0x0c, 0x1d, 0x0f, 0x07, 0x03, 0x06, 0x3c, 0x39, 0x07, 0x0f, 0x1b, 0x0f, 0x03, 0x00, 0x00, 0x00 };
static unsigned char const _abduction3[48] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xfc, 0x3e, 0x1f, 0xfe, 0x38, 0xec, 0xb8, 0xe0, 0xb8, 0xec, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x3f, 0x0e, 0x0c, 0x0d, 0x0c, 0x38, 0x0f, 0x1b, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
static unsigned char const _abduction4[48] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xfc, 0x1c, 0x76, 0x5c, 0xf0, 0x5c, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x0f, 0x06, 0x04, 0x07, 0x0d, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
static unsigned char const _abduction5[48] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xcc, 0x3a, 0xac, 0xf8, 0xac, 0x3a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x03, 0x03, 0x06, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
static unsigned char const _abduction6[48] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x35, 0x5f, 0x35, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

static unsigned char const _fart[8] = { 0x20, 0x54, 0x2a, 0x55, 0xaa, 0x55, 0xaa, 0x10 };

static unsigned char const _walk1[48] = { 0x00, 0x80, 0x70, 0xf8, 0x38, 0x18, 0xf8, 0xf8, 0x18, 0x18, 0x38, 0x70, 0xf0, 0x70, 0x20, 0xe6, 0xfe, 0xdc, 0xf4, 0x80, 0xf4, 0xdc, 0xfe, 0x06, 0x0c, 0x03, 0x00, 0xff, 0xfe, 0x0c, 0x1d, 0x0f, 0x1f, 0x07, 0x06, 0x06, 0x07, 0xc6, 0xfc, 0x1c, 0x1f, 0x77, 0x6d, 0x0f, 0x0d, 0x07, 0x07, 0x00 };
static unsigned char const _walk2[48] = { 0x00, 0x80, 0x70, 0xf8, 0x38, 0x18, 0xf8, 0xf8, 0x18, 0x18, 0x38, 0x70, 0xf0, 0x70, 0x20, 0xe6, 0xfe, 0xdc, 0xf4, 0x80, 0xf4, 0xdc, 0xfe, 0x06, 0x0c, 0x03, 0xc0, 0xff, 0x3e, 0x1c, 0x7d, 0x6f, 0x1f, 0x07, 0x06, 0x06, 0x67, 0x66, 0x3c, 0xfc, 0xff, 0x07, 0x0d, 0x0f, 0x0d, 0x07, 0x07, 0x00 }; 
static unsigned char const _walk3[48] = { 0x00, 0x80, 0x70, 0xf8, 0x38, 0x18, 0xf8, 0xf8, 0x18, 0x18, 0x38, 0x70, 0xf0, 0x70, 0x20, 0xe6, 0xfe, 0xdc, 0xf4, 0x80, 0xf4, 0xdc, 0xfe, 0x06, 0x0c, 0x03, 0x60, 0x7f, 0x1e, 0xfc, 0xfd, 0x0f, 0x1f, 0x07, 0x06, 0x06, 0x07, 0x06, 0xfc, 0xfc, 0x07, 0x07, 0x0d, 0x0f, 0x0d, 0x07, 0x07, 0x00 };

static unsigned char const _numbers[80] = { 0x00, 0x00, 0x6c, 0x82, 0x82, 0x6c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x6c, 0x00, 0x00, 0x00, 0x00, 0x60, 0x92, 0x92, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x92, 0x92, 0x6c, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x10, 0x10, 0x6c, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x92, 0x92, 0x60, 0x00, 0x00, 0x00, 0x00, 0x6c, 0x92, 0x92, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x02, 0x6c, 0x00, 0x00, 0x00, 0x00, 0x6c, 0x92, 0x92, 0x6c, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x92, 0x92, 0x6c, 0x00, 0x00 };

static unsigned char const _game_over[40] = { 0x00, 0x00, 0x38, 0x44, 0x54, 0x30, 0x00, 0x78, 0x14, 0x78, 0x00, 0x7c, 0x08, 0x10, 0x08, 0x7c, 0x00, 0x7c, 0x54, 0x44, 0x00, 0x00, 0x38, 0x44, 0x38, 0x00, 0x3c, 0x40, 0x3c, 0x00, 0x7c, 0x54, 0x44, 0x00, 0x7c, 0x14, 0x68, 0x00, 0x00, 0x00  };

static unsigned char _saucer_x = 56;	// (128 - 16) / 2
static unsigned char _saucer_y = 0;
static unsigned char _saucer_abducting = 0;

static unsigned char _cow_x = 52;
static unsigned char _cow_y = 48;

static unsigned char _fart_active = 0;
static unsigned char _fart_x = 0;
static unsigned char _fart_y = 0;

static unsigned char _cowState = NORMAL;
static unsigned char _score = 0;
static unsigned char _lives = 3;

int main() {
	unsigned char* saucer = (unsigned char*)_saucer;
	unsigned char* cow[10] = { 
		(unsigned char*)_cow, 
		(unsigned char*)_abduction1,
		(unsigned char*)_abduction2, 
		(unsigned char*)_abduction3, 
		(unsigned char*)_abduction4, 
		(unsigned char*)_abduction5, 
		(unsigned char*)_abduction6,
		(unsigned char*)_walk1,
		(unsigned char*)_walk2,
		(unsigned char*)_walk3  };
	unsigned char* fart_sprite = (unsigned char*)_fart;
	unsigned char* numbers = (unsigned char*)_numbers;
	unsigned char* game_over = (unsigned char*)_game_over;
	
	unsigned char keys = 0;
	unsigned char cowAnimation = 0;
	unsigned char frameCount = 0;
	unsigned char cowDir = 0;
	unsigned char fart = 0;
	unsigned char i = 0;

	api_init();

	fullscreenImage((unsigned char*)_title);

	DISPLAY();
	for (i = 0; i < 8; ++i) {
		DELAY_MS(255);
	}

	setTiles((unsigned char*)_deadbeef_tiles);
	LOAD_MUSIC((unsigned char*)_music);

	drawPlayfield();
	DRAW_SPRITE(numbers + (_score * 8), 120, 0, 8, 8, 0, DRAW_NOP);
	DRAW_SPRITE(numbers + (_lives * 8), 0, 0, 8, 8, 0, DRAW_NOP);

	for (;;) {
		++frameCount;

		if (_lives == 0) {
			DRAW_SPRITE(game_over, 44, 28, 40, 8, 0, DRAW_NOP);
			DISPLAY();
			break;
		}

		DRAW_SPRITE(saucer, _saucer_x, _saucer_y, 16, 8, 0, DRAW_NOP);
		if (_cowState != REGENERATING) {
			DRAW_SPRITE(cow[cowAnimation], _cow_x, _cow_y, 24, 16, cowDir, DRAW_NOP);
		}
		
		if (_fart_active) {
			DRAW_SPRITE(fart_sprite, _fart_x, _fart_y, 8, 8, 0, DRAW_OR);
		}
		

		if (_saucer_abducting == 1) {
			DRAW_LINE(_saucer_x + 6, _saucer_y + 8, _saucer_x + 6 - 16, 63, 1);
			DRAW_LINE(_saucer_x + 9, _saucer_y + 8, _saucer_x + 6 + 16, 63, 1);
		}

		DISPLAY();

		CLEAR_SPRITE(_saucer_x, _saucer_y, 16, 8);
		if (_cowState != REGENERATING) {
			CLEAR_SPRITE(_cow_x, _cow_y, 24, 16);
		}
		
		if (_fart_active) {
			CLEAR_SPRITE(_fart_x, _fart_y, 8, 8);

			_fart_y -= 2;
			if (_fart_y > 127) {
				_fart_active = 0;
			} else {
				if (_fart_y < 8) {
					if (_fart_x > (_saucer_x - 8) && _fart_x < (_saucer_x + 16)) {
						_fart_active = 0;
						--_lives;
						CLEAR_SPRITE(0, 0, 8, 8);
						DRAW_SPRITE(numbers + (_lives * 8), 0, 0, 8, 8, 0, DRAW_NOP);						
					}			
				}

				if (_fart_x < _saucer_x) {
					++_fart_x;
				} else if (_fart_x > _saucer_x) {
					--_fart_x;
				}
			}
		}
		
		if (_cowState == REGENERATING) {
			if ((frameCount % 16) == 0) {
				_cow_y = 48;
				cowAnimation = 0;
				_cowState = NORMAL;

				if (_saucer_x > 56) {
					_cow_x = _saucer_x - 24;
					cowDir = 1;

				} else {
					_cow_x = _saucer_x + 16;
					cowDir = 0;
				}
			}
		} else if (_cowState == ABDUCTING) {
			unsigned char a = 7 - (_cow_y / 7); // This is a trick to figure out which animation based open where on the screen
			if (a > cowAnimation) {
				cowAnimation = a;
			} 
			_cow_y -= 3;
		
			if (_cow_x < (_saucer_x - 4)) { // This lines up the cow to be centered with saucer as it goes up
				++_cow_x;
			} else if (_cow_x > (_saucer_x - 4)) {
				--_cow_x;
			}
			
			if (_cow_y < 8) { // Check if cow has been fully abducted
				_cow_y = 8;
				++_score;
				CLEAR_SPRITE(120, 0, 8, 8);
				DRAW_SPRITE(numbers + (_score * 8), 120, 0, 8, 8, 0, DRAW_NOP);
				_cowState = REGENERATING;			
			}
		} else if (_cowState == FALLING) {
			_cow_y += 5;
			if (_cow_y > 48) {
				_cow_y = 48;		
				_cowState = REGENERATING;
			}
		} else {
			if ((frameCount % 32) == 0) {		// Fart every so often
				_cowState = FARTING;
				cowAnimation = 0;
			} else if (_cowState == NORMAL) {
				if ((frameCount % 16) == 0) {	// The cow should stand for a bit before it starts walking
					cowAnimation = 7;			// Walk animation starts at 7
					if (cowDir == 0) {
						_cowState = RIGHT;
					} else {
						_cowState = LEFT;
					}
				}
			} else if (_cowState == RIGHT) {
				_cow_x += 2;
				++cowAnimation;
				if (cowAnimation > 9) {			// 9 is last animation in walk cycle
					cowAnimation = 7;
				}
				if (_cow_x > 104) {
					_cow_x = 104;
					_cowState = LEFT;
					cowDir = 1;
					cowAnimation = 7;
				}
			} else if (_cowState == LEFT) {
				_cow_x -= 2;
				++cowAnimation;
				if (cowAnimation > 9) {
					cowAnimation = 7;
				}
				if (_cow_x > 127) {				// A check of > 127 is really a check of < 0 in unsigned world
					_cow_x = 0;
					_cowState = RIGHT;
					cowDir = 0;
					cowAnimation = 7;
				} 
			} else if (_cowState == FARTING) {
				if ((frameCount % 8) == 0) {	// After a bit of time walk again
					_cowState = (cowDir == 0) ? RIGHT : LEFT;
					cowAnimation = 7;
				} else if ((frameCount % 4) == 0) {	// After standing for a bit, initiate the fart
					if (_fart_active == 0) {
						if (cowDir == 0) {	// Right
							if (_cow_x >= 8) {
								_fart_active = 1;
								_fart_x = _cow_x - 8;
								_fart_y = _cow_y;
							}
						} else {
							if (_cow_x < 96) {
								_fart_active = 1;
								_fart_x = _cow_x + 24;
								_fart_y = _cow_y;
							}
						}
					}								
				}
			}
		}

		keys = READ_BUTTONS();
		if (_saucer_abducting == 0) {
			if ((keys & 4) == 0) {
				_saucer_x -= 3;
			} 
			else if ((keys & 8) == 0) {
				_saucer_x += 3;
			}

			if (_saucer_x < 10) {
				_saucer_x = 10;
			}
			else if (_saucer_x > 105) {
				_saucer_x = 105;
			}
		}	

		if (((keys & 16) == 0) && (_lives > 0)) {
			if (_saucer_abducting == 0) {
				_saucer_abducting = 1;
				PLAY_EFFECT((unsigned char*)_abduction_effect);
			}

			if (_cowState != ABDUCTING && _cowState != REGENERATING) {
				if (_cow_x > (_saucer_x - 10)  &&
					_cow_x < (_saucer_x + 2)) {
					_cowState = ABDUCTING;
					cowAnimation = 0;
				}
			}
		} else {
			if (_saucer_abducting) {
				_saucer_abducting = 0;
				PLAY_EFFECT(0);

				DRAW_LINE(_saucer_x + 6, _saucer_y + 8, _saucer_x + 6 - 16, 63, 0);
				DRAW_LINE(_saucer_x + 9, _saucer_y + 8, _saucer_x + 6 + 16, 63, 0);
				
				if (_cowState == ABDUCTING) {
					_cowState = FALLING;
				}
			}
		}

		LED_ON();
		WAIT();
		LED_OFF();
	}

	for (;;) {

	}

	return 0;
}